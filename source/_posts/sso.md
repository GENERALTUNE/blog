---
title: 单点登录实现
date: 2019-09-22 15:35:45
tags:
---
## 概念
单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。
### CAS协议中概念介绍
SSO单点登录只是一个方案，而目前市面上最流行的单端登录系统是由耶鲁大学开发的CAS系统，而由其实现的CAS协议，也成为目前SSO协议中的既定协议，下文中的单点登录协议及结构，均为CAS中的体现结构
CAS协议中有以下几个概念：
1. CAS Client：需要集成单点登录的应用，称为单点登录客户端
2. CAS Server：单点登录服务器，用户登录鉴权、凭证下发及校验等操作
3. TGT：ticker granting ticket，用户凭证票据，用以标记用户凭证，用户在单点登录系统中登录一次后，再其有效期内，TGT即代表用户凭证，用户在其它client中无需再进行二次登录操作，即可共享单点登录系统中的已登录用户信息
4. ST：service ticket，服务票据，服务可以理解为客户端应用的一个业务模块，体现为客户端回调url，CAS用以进行服务权限校验，即CAS可以对接入的客户端进行管控
5. TGC：ticket granting cookie，存储用户票据的cookie，即用户登录凭证最终映射的cookies
![cas](cas.png)
### OAUTH、OPENID、SAML、CAS做统一认证与授权的联系与区别
首先，SSO和权限控制是两回事：
- CAS系统解决单点登录问题，对身份认证的具体方法不做要求。
- Oauth、openID、SAML是身份身份认证授权的规范和标准，是解决认证授权问题的。
OpenID与Oauth协议的区别，可以从其标准定义的核心应用场景来分析：
1、Oauth协议的使用场景：用户通过第三方照片打印应用打印在某个网站存储的照片，而不希望泄露照片网站的用户名、密码等信息给第三方的照片打印应用。
2、OpenID协议的使用场景，用户在多个网站注册，需要注册并记住多个用户名密码，openid希望帮用户提供一个身份ID，可以在多个网站用来登录。登录网站时，用户选择用其身份ID登录，跳转到身份ID颁发的网站输入用户名、密码进行身份认证，然后跳转会网站实现登录。即我们当前很多时候看到的用”QQ帐号登录”、“微信帐号登录”等。

所以我们可以总结，两个协议的核心区别：
1、Oauth协议的认证凭证必须是资源拥有者发放的；而OpenID的认证凭证可以是你需要登录的网站支持的其它任何正规Openid Provier网站均可。
2、OpenID只是身份的象征，可以看作是身份证；而Oauth认证凭证，一定是资源拥有者发放的，不仅是用户在资源拥有者系统身份的凭证，还是其某些授权资源访问的凭证，可以看作是钥匙。
3、SAML支持XACML协议进行权限控制。SAML协议较OAUTH来说确实比较复杂，但是功能也十分强大，支持认证，权限控制和用户属性。
进一步，我们开发时候，如果是单系统身份认证，根据使用场景和技术特点，选择OpenID、Oauth、或者SAML。如果不是单系统，不仅涉及身份认证，而是涉及众多系统需要单点登录，则需要选择CAS认证方案(OpenID/Oauth/SAML)来实现的。
OAuth2.0认证和授权机制讲解：
认证和授权过程（包括三方）
　　1、服务提供方，用户使用服务提供方来存储受保护的资源，如照片，视频，联系人列表。
　　2、用户，存放在服务提供方的受保护的资源的拥有者。
　　3、客户端，要访问服务提供方资源的第三方应用，通常是网站。在认证过程之前，客户端要向服务提供者申请客户端标识。

## 实现方法
### server端
以server群如何生成、验证ID的方式大致分为两种：
>- “共享Cookie”这个就是上面提到的共享session的方式，我倒觉得叫“共享session”来得好一点，本质上cookie只是存储session-id的介质，session-id也可以放在每一次请求的url里。据说这种方式不安全，我没去细究，哪位大神可以推荐下相关的资料，我后期补上。其实也是，毕竟session这项机制一开始就是一个server一个session的，把session拿出来让所有server共享确实有点奇怪。
>- SSO-Token方式因为共享session的方式不安全，所以我们不再以session-id作为身份的标识。我们另外生成一种标识，把它取名SSO-Token(或Ticket)，这种标识是整个server群唯一的，并且所有server群都能验证这个token，同时能拿到token背后代表的用户的信息。我们要讨论的也是这种方式，一会上具体流程图。
### 浏览器端
>- 单点登录还有非常关键的一步，这一步跟server端验证token的方式无关，用最早的“共享session”的方式还是现在的“token”方式，身份标识到了浏览器端都要面临这样的一个问题：用户登录成功拿到token(或者是session-id)后怎么让浏览器存储和分享到其它域名下？同域名很简单，把token存在cookie里，把cookie的路径设置成顶级域名下，这样所有子域都能读取cookie中的token。这就是共享cookie的方式（这才叫共享Cookie嘛，上面那个应该叫共享session）。比如：谷歌公司，google.com是他的顶级域名，邮箱服务的mail.google.com和地图服务的map.google.com都是它的子域。但是，跨域的时候怎么办？谷歌公司还有一个域名，youtube.com，提供视频服务 [2]  。


## 技术实现机制
当用户第一次访问应用系统的时候，因为还没有登录，会被引导到认证系统中进行登录；根据用户提供的登录信息，认证系统进行身份校验，如果通过校验，应该返回给用户一个认证的凭据－－ticket；用户再访问别的应用的时候，就会将这个ticket带上，作为自己认证的凭据，应用系统接受到请求之后会把ticket送到认证系统进行校验，检查ticket的合法性。如果通过校验，用户就可以在不用再次登录的情况下访问应用系统2和应用系统3了。要实现SSO，需要以下主要的功能：
>- 所有应用系统共享一个身份认证系统。统一的认证系统是SSO的前提之一。认证系统的主要功能是将用户的登录信息和用户信息库相比较，对用户进行登录认证；认证成功后，认证系统应该生成统一的认证标志（ticket），返还给用户。另外，认证系统还应该对ticket进行效验，判断其有效性。
>- 所有应用系统能够识别和提取ticket信息 要实现SSO的功能，让用户只登录一次，就必须让应用系统能够识别已经登录过的用户。应用系统应该能对ticket进行识别和提取，通过与认证系统的通讯，能自动判断当前用户是否登录过，从而完成单点登录的功能。
![单点登录示意图](p1.png)
